name: Build and Publish lm-buddy

on: 
  push:
    tags:
      - "v*"
  pull_request:
    branches:
      - "main"
      - "dev"
      - "release/v[0-9].[0-9]"
  workflow_dispatch:

jobs:
    build_dist:
      name: Build distribution ðŸ“¦
      runs-on: ubuntu-latest
      outputs:
        POETRY: ${{ env.POETRY }}
        DIST: ${{ env.DIST }}
      steps:
      - uses: actions/checkout@v4
      - name: set up python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: set up poetry

        run: |
          export VENV_PATH="$HOME/venv" 
          python3 -m venv $VENV_PATH 
          $VENV_PATH/bin/pip install -U pip setuptools
          $VENV_PATH/bin/pip install poetry
          export POETRY="$VENV_PATH/bin/poetry"
          export DIST="$GITHUB_WORKSPACE/dist"
          $POETRY config repositories.testpypi https://test.pypi.org/legacy/
          cd "$GITHUB_WORKSPACE"

      - name: build_dist
        run: |
            $POETRY build
            ls ./dist/
      - name: Archive Production Artifact
        uses: actions/upload-artifact@main
        with:
          name: dist
          path: dist

    publish-testpypi:
        name: >-
            Publish dist to test pypi
        needs:
        - build_dist
        runs-on: ubuntu-latest
        env:
            POETRY: ${{  needs.build_dist.outputs.POETRY }}
            DIST: ${{  needs.build_dist.outputs.DIST }}
            POETRY_PYPI_TOKEN_TESTPYPI: ${{ secrets.PYPI_TEST_KEY }}

        if: ${{ github.event_name == 'pull_request' }}
        steps:
        - name: prepare with poetry
          run: |
            cd $GITHUB_WORKSPACE
            $POETRY publish --repository testpypi
    
    publish-pypi:

        name: >-
            Publish dist to real pypi
        needs:
        - build_dist
        runs-on: ubuntu-latest
        env:
            POETRY_PYPI_TOKEN: ${{ secrets.PYPI_KEY }}
            POETRY: ${{  needs.build_dist.outputs.POETRY }}
            DIST: ${{  needs.build_dist.outputs.DIST }}
        if: endsWith(github.event.base_ref, 'main') == true
        steps:
        - name: prepare with poetry
          run: |
            $POETRY publish --repository testpypi --build

    github-release:
        name: >-
            Sign the Python ðŸ distribution ðŸ“¦ with Sigstore
            and upload them to GitHub Release
        needs:
        - build_dist
        - publish-pypi # will error if this step fails
        runs-on: ubuntu-latest
    
        permissions:
            contents: write  # IMPORTANT: mandatory for making GitHub Releases
            id-token: write  # IMPORTANT: mandatory for sigstore
    
        # should only run when commits are pushed to main and a tag is there (from above)
        if: endsWith(github.event.base_ref, 'main') == true
        steps:
        - name: get dists
          uses: actions/download-artifact@main
          with:
            name: dist
            path: dist
        - name: Sign the dists with Sigstore
          uses: sigstore/gh-action-sigstore-python@v1.2.3
          with:
              inputs: >-
                ./dist/*.tar.gz
                ./dist/*.whl

        - name: Create GitHub Release
          env:
              GITHUB_TOKEN: ${{ github.token }}
          run: >-
            gh release create
            '${{ github.ref_name }}'
            --repo '${{ github.repository }}'

        - name: Upload artifact signatures to GitHub Release
          env:
            GITHUB_TOKEN: ${{ github.token }}
          # Upload to GitHub Release using the `gh` CLI.
          # `dist/` contains the built packages, and the
          # sigstore-produced signatures and certificates.
          run: >-
            gh release upload
            '${{ github.ref_name }}' dist/**
            --repo '${{ github.repository }}'
        
    